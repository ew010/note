name: Build Offline Apps (All Platforms)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: error

  build-ios-simulator:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build iOS Simulator app (no signing)
        run: flutter build ios --simulator --debug --no-codesign

      - name: Package iOS Simulator app
        run: |
          mkdir -p dist
          ditto -c -k --sequesterRsrc --keepParent build/ios/iphonesimulator/Runner.app dist/note-ios-simulator.zip

      - name: Upload iOS simulator artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-ios-simulator
          path: dist/note-ios-simulator.zip
          if-no-files-found: error

  build-ios-device-ipa:
    if: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 != '' && secrets.IOS_CERTIFICATE_PASSWORD != '' && secrets.IOS_PROVISIONING_PROFILE_BASE64 != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
    runs-on: macos-latest
    env:
      IOS_CERTIFICATE_P12_BASE64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare signing files
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PASSWORD="$(uuidgen)"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

          echo -n "$IOS_CERTIFICATE_P12_BASE64" | base64 --decode > /tmp/ios-cert.p12
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo -n "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/note.mobileprovision"

      - name: Import certificate to keychain
        shell: bash
        run: |
          set -euo pipefail
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import /tmp/ios-cert.p12 -k "$HOME/Library/Keychains/build.keychain-db" -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$HOME/Library/Keychains/build.keychain-db" "$HOME/Library/Keychains/login.keychain-db"
          security default-keychain -d user -s "$HOME/Library/Keychains/build.keychain-db"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$HOME/Library/Keychains/build.keychain-db"

      - name: Apply bundle id and team id
        shell: bash
        run: |
          set -euo pipefail
          perl -0pi -e "s/PRODUCT_BUNDLE_IDENTIFIER = com\\.example\\.note;/PRODUCT_BUNDLE_IDENTIFIER = ${IOS_BUNDLE_ID};\\n\\t\\t\\t\\tDEVELOPMENT_TEAM = ${IOS_TEAM_ID};/g" ios/Runner.xcodeproj/project.pbxproj

      - name: Build signed IPA
        shell: bash
        run: |
          set -euo pipefail
          METHOD="${IOS_EXPORT_METHOD:-ad-hoc}"
          flutter build ipa --release --export-method "$METHOD"

      - name: Upload signed iOS IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-ios-ipa-signed
          path: build/ios/ipa/*.ipa
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS app
        run: flutter build macos --release

      - name: Package macOS app
        run: |
          mkdir -p dist
          ditto -c -k --sequesterRsrc --keepParent build/macos/Build/Products/Release/note.app dist/note-macos.zip

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-macos-offline
          path: dist/note-macos.zip
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release

      - name: Package Windows app
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath dist/note-windows.zip -Force

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-windows-offline
          path: dist/note-windows.zip
          if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux app
        run: flutter build linux --release

      - name: Package Linux app
        run: |
          mkdir -p dist
          tar -C build/linux/x64/release -czf dist/note-linux.tar.gz bundle

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-linux-offline
          path: dist/note-linux.tar.gz
          if-no-files-found: error

  build-web-bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web app
        run: flutter build web --release

      - name: Package Web bundle
        run: |
          mkdir -p dist
          tar -C build -czf dist/note-web.tar.gz web

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: note-web-offline
          path: dist/note-web.tar.gz
          if-no-files-found: error
